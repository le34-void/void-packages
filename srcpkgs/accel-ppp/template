# Template file for 'accel-ppp'
pkgname=accel-ppp
version=20230127
revision=2
_commit=cc8f2bada5635768d425e2fa2bafb095acda8ca9
build_style=cmake
configure_args="-DCMAKE_SYSTEM_NAME=Linux
 -DCMAKE_INSTALL_PREFIX=/usr
 -DCMAKE_BUILD_TYPE=Release
 -DLOG_FILE=TRUE
 -DLOG_PGSQL=FALSE
 -DSHAPER=TRUE
 -DRADIUS=TRUE
 -DNETSNMP=FALSE
 -DLUA=TRUE
 -DLUA_INCLUDE_DIR="/usr/include/lua5.1""
conf_files="/etc/accel-ppp.conf /etc/accel-ppp.lua"
make_dirs="
 /var/log/accel-ppp 0755 root root
 /var/lib/accel-ppp 0755 root root"
makedepends="libnl-devel lua51-devel openssl-devel pcre-devel"
depends="openssl pcre libnl lua51"
short_desc="High performance PPTP/L2TP/PPPoE/IPoE server"
maintainer="Alexandr <joe.satriani@le34.ru>"
license="GPL-2.0-or-later"
homepage="https://accel-ppp.org"
distfiles="https://github.com/xebd/${pkgname}/archive/${_commit}.tar.gz"
checksum=d0e6b858b56402b9478b9a40a4e2887ff5f53756211dde3fa49bfa5f63c31d3e

case "$XBPS_TARGET_MACHINE" in
	*-musl)
		makedepends+=" libucontext-devel"
esac

pre_configure() {
	if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
		touch /tmp/musl
		for f in "${FILESDIR}"/musl-patches/*.patch
		do
			patch -p1 < $f
		done
	fi
}
post_install() {
	vdoc README
	#vlicense COPYING
	vsv accel-pppd
	vconf "${wrksrc}/accel-pppd/accel-ppp.conf"
	vsconf "${wrksrc}/accel-pppd/accel-ppp.conf"
	vconf ${FILESDIR}/accel-ppp.lua
	vinstall ${FILESDIR}/accel-ppp.logrotate 644 etc/logrotate.d accel-ppp
	vinstall ${FILESDIR}/dictionary.accel_ipoe 644 usr/share/accel-ppp/radius
	vinstall ${FILESDIR}/dictionary.abills 644 usr/share/accel-ppp/radius
	vinstall ${wrksrc}/accel-pppd/extra/net-snmp/ACCEL-PPP-MIB.txt 644 usr/share/snmp/mibs
}
accel-ppp-ipoe-dkms_package() {
	short_desc+=" - kernel module sources for dkms"
	dkms_modules="accel-ppp-ipoe ${version}"
	depends="dkms lua51-devel"

	pkg_install() {
		vmkdir usr/src/accel-ppp-ipoe-${version}
		vcopy "drivers/ipoe/*" usr/src/accel-ppp-ipoe-${version}
		vinstall "${FILESDIR}/ipoe.dkms" 0644 usr/src/accel-ppp-ipoe-${version} dkms.conf
		sed -e "s/@PKGNAME@/${pkgname}/" \
			-e "s/@PKGVER@/${version}/" -i ${PKGDESTDIR}/usr/src/accel-ppp-ipoe-${version}/dkms.conf
	}
}
accel-ppp-vlanmon-dkms_package() {
	short_desc+=" - kernel module sources for dkms"
	dkms_modules="accel-ppp-vlanmon ${version}"
	depends="dkms"

	pkg_install() {
		vmkdir usr/src/accel-ppp-vlanmon-${version}
		vcopy "drivers/vlan_mon/*" usr/src/accel-ppp-vlanmon-${version}
		vinstall "${FILESDIR}/vlanmon.dkms" 0644 usr/src/accel-ppp-vlanmon-${version} dkms.conf
		sed -e "s/@PKGNAME@/${pkgname}/" \
			-e "s/@PKGVER@/${version}/" -i ${PKGDESTDIR}/usr/src/accel-ppp-vlanmon-${version}/dkms.conf
	}
}
